<!DOCTYPE html>
<html lang="en">
<head>
    <!-- (Meta, style, and head contents unchanged) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/svg+xml" href="scan.svg">
    <link rel="shortcut icon" href="scan.svg">
    <title>SMS Scan My Serial - Professional Barcode Scanner</title>
    <meta name="description" content="Professional barcode and serial number scanner for inventory tracking with camera access and CSV export">
    <meta name="author" content="SMS Scan My Serial">
    <meta property="og:title" content="SMS Scan My Serial - Professional Barcode Scanner">
    <meta property="og:description" content="Professional barcode and serial number scanner for inventory tracking with camera access and CSV export">
    <meta property="og:type" content="website">
    <!-- Barcode scanning with ZXing library -->
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        /* (CSS unchanged) */
        /* ... (your full CSS remains here) ... */
    </style>
</head>
<body>
    <!-- Header, Main, Data Table, Footer unchanged -->
    <!-- ... (all your existing HTML up to the Manual Entry form) ... -->
    <!-- Manual Tab Content -->
    <div class="tabs-content" id="manual-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10 2 10 2s-1.04.54-1.5 1.34l-.5.68-.5-.67C6.5 2.54 5 4 5 5c0 .3[...]"/>
                    </svg>
                    Manual Entry
                </div>
            </div>
            <div class="card-content">
                <form id="manual-form" class="form">
                    <input id="product-name" class="input" placeholder="Product Name" required>
                    <input id="serial-number" class="input" placeholder="Serial Number (e.g., CCX9R-68N2A-69HGD-D4WHC-VAWG9)" required>
                    <small style="color: var(--muted-foreground);margin-top:-10px;">
                        Accepts all serials, including Microsoft keys in the format XXXXX-XXXXX-XXXXX-XXXXX-XXXXX
                    </small>
                    <button type="submit" class="btn">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        Add Item
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- ... (rest of your HTML unchanged) ... -->

    <script>
        // Application State
        let scannedItems = [];
        let nextId = 1; // Start from 1 and increment
        let cameraActive = false;
        let currentStream = null;
        let scanningInterval = null;
        let isScanning = false;

        // DOM Elements
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const cameraToggleBtn = document.getElementById('camera-toggle');
        const cameraInactive = document.getElementById('camera-inactive');
        const scanningOverlay = document.getElementById('scanning-overlay');
        const manualForm = document.getElementById('manual-form');
        const productNameInput = document.getElementById('product-name');
        const serialNumberInput = document.getElementById('serial-number');
        const totalItemsSpan = document.getElementById('total-items');
        const recentItemsSpan = document.getElementById('recent-items');
        const emptyState = document.getElementById('empty-state');
        const tableContainer = document.getElementById('table-container');
        const tableBody = document.getElementById('table-body');
        const exportCsvBtn = document.getElementById('export-csv');
        const clearAllBtn = document.getElementById('clear-all');

        // Regex for Microsoft serial keys: 5 groups of 5 alphanumeric, separated by hyphens
        const msSerialRegex = /^[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}$/i;

        // Utility Functions
        function generateId() {
            return nextId++;
        }

        function showToast(title, message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="font-weight: 600;">${title}</div>
                <div style="font-size: 0.875rem; margin-top: 0.25rem;">${message}</div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 4000);
        }

        function updateStats() {
            totalItemsSpan.textContent = scannedItems.length;
            const oneMinuteAgo = Date.now() - 60000;
            const recentCount = scannedItems.filter(item => 
                new Date(item.timestamp).getTime() > oneMinuteAgo
            ).length;
            recentItemsSpan.textContent = recentCount;
        }

        function updateTable() {
            if (scannedItems.length === 0) {
                emptyState.style.display = 'block';
                tableContainer.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                tableContainer.style.display = 'block';
                tableBody.innerHTML = scannedItems.map(item => `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.875rem;">${item.id}</td>
                        <td style="font-weight: 500;">${item.productName}</td>
                        <td style="font-family: monospace;">${item.serialNumber}</td>
                        <td style="font-size: 0.875rem; color: var(--muted-foreground);">
                            ${new Date(item.timestamp).toLocaleString()}
                        </td>
                    </tr>
                `).join('');
            }
            updateStats();
        }

        // Enhanced addItem to support Microsoft serial keys format
        function addItem(productName, serialNumber, fromScan = false) {
            // Check for duplicate serial numbers
            const isDuplicate = scannedItems.some(item => 
                item.serialNumber.toLowerCase() === serialNumber.toLowerCase()
            );
            if (isDuplicate) {
                showToast(
                    "Duplicate Serial Number",
                    "This serial number has already been scanned. Each serial can only be added once.",
                    'warning'
                );
                return;
            }
            // If matches Microsoft serial key format, force to uppercase
            if (msSerialRegex.test(serialNumber)) {
                serialNumber = serialNumber.toUpperCase();
                if (!productName || productName.trim() === "") {
                    productName = "Microsoft Key";
                }
            }
            const newItem = {
                id: generateId(),
                productName: productName,
                serialNumber: serialNumber,
                timestamp: new Date().toISOString()
            };
            scannedItems.unshift(newItem);
            updateTable();
            const action = fromScan ? 'Scanned' : 'Added';
            showToast(
                `Item ${action}`,
                `${productName} (ID: ${newItem.id}) has been ${action.toLowerCase()} successfully`,
                'success'
            );
        }

        // Tab Functionality
        function initTabs() {
            const triggers = document.querySelectorAll('.tabs-trigger');
            const contents = document.querySelectorAll('.tabs-content');
            triggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const tabId = trigger.getAttribute('data-tab');
                    triggers.forEach(t => t.classList.remove('active'));
                    trigger.classList.add('active');
                    contents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-content`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
        }

        // Handle result text from barcode or manual scan
        function handleScannedText(scannedText) {
            let productName = "Barcode";
            let serialNumber = scannedText;
            // Check for Microsoft serial key format
            if (msSerialRegex.test(scannedText)) {
                productName = "Microsoft Key";
                serialNumber = scannedText.toUpperCase();
            }
            addItem(productName, serialNumber, true);
        }

        // Barcode scanning handler patched for Microsoft serial support
        function startBarcodeScanning() {
            if (!videoElement || !currentStream) return;
            if (isScanning) return;
            isScanning = true;
            const codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
                if (result) {
                    handleScannedText(result.text);
                    codeReader.reset();
                    setTimeout(() => {
                        isScanning = false;
                        startBarcodeScanning();
                    }, 2000);
                }
                // else: ignore errors, keep scanning
            });
        }

        // Camera function, unchanged except for barcode handler reference
        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not supported in this browser');
                }
                const constraints = { 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 }
                    } 
                };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = currentStream;
                videoElement.style.display = 'block';
                cameraInactive.style.display = 'none';
                scanningOverlay.style.display = 'flex';
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play().then(resolve).catch(resolve);
                    };
                });
                if (typeof ZXing !== 'undefined') {
                    startBarcodeScanning();
                }
                cameraActive = true;
                updateCameraButton();
                const message = typeof ZXing !== 'undefined' 
                    ? "Camera is now active. Point at a barcode or printed Microsoft serial key to scan automatically."
                    : "Camera is now active. Use Manual Entry for serial numbers.";
                showToast(
                    "Camera Started",
                    message,
                    'success'
                );
            } catch (error) {
                console.error('Camera error:', error);
                cameraInactive.style.display = 'flex';
                scanningOverlay.style.display = 'none';
                let errorMessage = "Camera access is required to use the scanner";
                let errorTitle = "Camera Access Required";
                if (error.message.includes('not supported')) {
                    errorMessage = "Camera is not supported in this browser. Please use a modern browser like Chrome, Firefox, or Safari.";
                    errorTitle = "Camera Not Supported";
                } else if (error.name === 'NotAllowedError') {
                    errorMessage = "Please allow camera access in your browser settings to use the scanner.";
                    errorTitle = "Camera Permission Denied";
                } else if (error.name === 'NotFoundError') {
                    errorMessage = "Camera not found. Please check if your camera is connected and not being used by another application.";
                    errorTitle = "Camera Not Available";
                }
                showToast(errorTitle, errorMessage, 'error');
            }
        }

        function updateCameraButton() {
            if (cameraActive) {
                cameraToggleBtn.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5[...]"/>
                    </svg>
                    Stop Camera
                `;
            } else {
                cameraToggleBtn.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5[...]"/>
                    </svg>
                    Start Camera
                `;
            }
        }

        // Manual form submission
        manualForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const productName = productNameInput.value.trim();
            const serialNumber = serialNumberInput.value.trim();
            addItem(productName, serialNumber, false);
            manualForm.reset();
        });

        // (Other event listeners, CSV export, Clear All, etc. stay unchanged)

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            initTabs();
            updateTable();
            cameraToggleBtn.addEventListener('click', function() {
                if (!cameraActive) {
                    startCamera();
                } else {
                    // Stop camera
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                        currentStream = null;
                    }
                    cameraActive = false;
                    videoElement.style.display = 'none';
                    cameraInactive.style.display = 'flex';
                    scanningOverlay.style.display = 'none';
                    updateCameraButton();
                }
            });
            exportCsvBtn.addEventListener('click', function() {
                if (scannedItems.length === 0) {
                    showToast("No Items", "Nothing to export.", "warning");
                    return;
                }
                let csv = "ID,Product Name,Serial Number,Timestamp\n";
                csv += scannedItems.map(item =>
                    `${item.id},"${item.productName}","${item.serialNumber}","${item.timestamp}"`
                ).join('\n');
                const blob = new Blob([csv], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "scanned-serials.csv";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Exported", "CSV file has been downloaded.", "success");
            });
            clearAllBtn.addEventListener('click', function() {
                if (confirm("Are you sure you want to clear all scanned serials? This cannot be undone.")) {
                    scannedItems = [];
                    nextId = 1;
                    updateTable();
                    showToast("Cleared", "All scanned items have been removed.", "success");
                }
            });
        });
    </script>
</body>
</html>
